---
title: "Visualisation"
author: "Guillaume Slizewicz"
date: "22 August 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#######LIBRARIES
library(plotly)
library("ggmap")# getting maps and coordinates from google
library(maptools)# getting maps and coordinates from google
library(maps)# getting maps and coordinates from google
library("ggplot2")# plotting the data
library(dplyr)#tidying dataset
library(rworldmap)
library(stringr)#dealing with strings and replacing strings in observations
library(RCurl)

#####MAIN FILE
df.viz<- read.csv("https://raw.githubusercontent.com/basgpol/SDS-group12/master/Exam_project/transferdata.final.csv", encoding = "UTF8", header = TRUE)

df.viz<- filter(df.viz,transfer.fee>0)


#######TRANSFER PATH
transfer.path.full = read.csv("https://raw.githubusercontent.com/basgpol/SDS-group12/master/Exam_project/transfer_path_full.csv", header=TRUE, stringsAsFactors=TRUE, fileEncoding="UTF8") # loading saved version of uncleaned player data

myLocation <- "Zurich"
myMap <- get_map(location= myLocation,
                 source="stamen", maptype="watercolor", crop=FALSE,zoom=4)

gg<-ggmap(myMap)+#calling map
  geom_path(aes(x = lon, y = lat, group = factor(name)), #putting paths on the map
            colour="red", data = transfer.path.full, alpha=0.3)

#######European maps of clubs
df.spending.club<-read.csv("https://raw.githubusercontent.com/basgpol/SDS-group12/master/Exam_project/df_spending_club_with_geo.csv", encoding = "UTF8", header = TRUE)

m <- list(
  colorbar = list(title = "Total transfer spending"),
  size = 10, opacity = 0.8, symbol = 'circle'
)

g <- list(
  scope = 'europe',
  projection = list(type = 'mercator'),
  showland = TRUE,
  landcolor = toRGB("gray95"),
  subunitcolor = toRGB("gray85"),
  countrycolor = toRGB("gray85"),
  countrywidth = 0.5,
  subunitwidth = 0.5
)

#######AGE

p.age = ggplot(df.viz, aes(x = transferage , y = transfer.fee))
p.age<-p.age + geom_point(stat = "identity")+
          #geom_point(aes(text = paste("Name:",name))+
          geom_smooth(aes(colour = transferage, fill = transferage))+
          ggtitle("Age repartition of transfers in European leagues")
plotly.p.age<-ggplotly(p.age)

#####TIME LEFT
p.time <- ggplot(data=df.viz, aes(x = contract.left.month , y = transfer.fee)) +
  geom_point(stat = "identity")+
  #geom_point(aes(text = paste(name, " to ", club.to)), size = 4) +
  geom_smooth(aes(colour = contract.left.month, fill = contract.left.month))+
  ggtitle("Time left on contract seems to be positively correlated with transfer fees")

plotly.p.time <- ggplotly(p.time)
###Average spending per league

df.viz.ave<-df.viz %>% 
  group_by(league) %>% 
  dplyr::summarise(
    mean.transfer=mean(transfer.fee))
df.viz.ave$mean.transfer<-as.numeric(df.viz.ave$mean.transfer)
p.spend = ggplot(df.viz.ave, aes( x =league, y=mean.transfer))
p.spend<-p.spend + geom_bar(stat="identity")+
  theme(axis.title.x=element_blank(),
        axis.text.x =element_text(size  = 7,
                                  angle = 45,
                                  hjust = 1,
                                  vjust = 1),
        axis.ticks= element_line(color=NA),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.title.y=element_blank(),
        text=element_text(family="Goudy Old Style"))+
  ggtitle("Premier League Clubs spend far more on average than other leagues' clubs")

#####Club status
df.viz.status<-df.viz %>% 
  group_by(Status) %>% 
  dplyr::summarise(mean.transfer=mean(transfer.fee))

p.club = ggplot(df.viz.status, aes(y= mean.transfer, x = Status))
p.club<- p.club + geom_bar(stat = "identity")+
  theme(axis.title.x=element_blank(),
        axis.text.x =element_text(size  = 7,
                                  angle = 45,
                                  hjust = 1,
                                  vjust = 1),
        axis.ticks= element_line(color=NA),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.title.y=element_blank(),
        text=element_text(family="Goudy Old Style"))+
  ggtitle("Top Club spend far more on average than other leagues' clubs")


```

## Visualisation

Some examples of visualisations

```{r cars}
#including Summary

```



```{r pressure, echo=FALSE}
## Including Plots

ggmap(myMap)


gg
plot_ly(df.spending.club, lat = lat, lon = lon,  color = transfer.fee.total,
        #text = team,
        hoverinfo = "text" ,
        text=paste("Team = ", df.spending.club$team,"\n", "Total transfer = ", df.spending.club$transfer.fee.total),
        type = 'scattergeo', locationmode = 'ISO-3', mode = 'markers', 
        marker = m) %>%
  layout(title = 'Football teams in Europe and transfer spending', geo = g)

p.age

plotly.p.age

plotly.p.time

p.spend

p.club

```

